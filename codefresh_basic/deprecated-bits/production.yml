# This is the "production" pipeline workflow.
# It is basically identical to the staging workflow except it removes the promote approval step.

version: '1.0'
stages:
  - prepare
  - deploy
  - promote
  - cleanup
steps:
  cloneRepo:
    stage: prepare
    title: Cloning main repository...
    type: git-clone
    repo: '${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}'
    revision: '${{CF_REVISION}}'
    git: github
  deployStack:
    stage: deploy
    title: Deploy Stack
    fail_fast: false
    image: pulumi/pulumi
    working_directory: ${{CF_VOLUME_PATH}}/pulumi_env
    commands:
      - rm -rf * # clean up any old stuff
      - export PULUMI_PROJECT=cf-`echo $CF_PIPELINE_NAME | cut -d"/" -f1`
      - export PULUMI_STACK=`echo $CF_PIPELINE_NAME | cut -d"/" -f2`
      - export PULUMI_FULLSTACK=$PULUMI_ORG/$PULUMI_PROJECT/$PULUMI_STACK
      - cf_export PULUMI_FULLSTACK # used in later steps
      - pulumi new aws-typescript -g -f -y -n $PULUMI_PROJECT -d $PULUMI_PROJECT
      - mv ../${{CF_REPO_NAME}}/* . # overwrite the files initialized by the pulumi new with the git-cloned files.
      - npm install
      - pulumi stack select $PULUMI_FULLSTACK --create # use or create a stack
      - pulumi config set aws:region us-east-1
      - pulumi up --skip-preview --non-interactive --yes # --debug --logtostderr -v 9
  askToCleanup:
    type: pending-approval
    stage: cleanup
    title: Tear down demo?
    fail_fast: false
    timeout: # force a clean up after "duration" hours.
      duration: 1
      finalState: approved
  # destroy stack regardless of how answered.
  destroyPulumiStack:
    stage: cleanup
    title: Destroy Stack
    fail_fast: false
    image: pulumi/pulumi
    working_directory: ${{deployStack}}
    commands: # need to recreate stuff since using pending-approval type and not enabling "build remains active" policy for the account or pipeline
      - export PULUMI_PROJECT=cf-`echo $CF_PIPELINE_NAME | cut -d"/" -f1`
      - export PULUMI_STACK=`echo $CF_PIPELINE_NAME | cut -d"/" -f2`
      - export PULUMI_FULLSTACK=$PULUMI_ORG/$PULUMI_PROJECT/$PULUMI_STACK
      - pulumi new aws-typescript -g -f -y -n $PULUMI_PROJECT -d $PULUMI_PROJECT
      - pulumi stack select $PULUMI_FULLSTACK --create
      - pulumi destroy -s $PULUMI_FULLSTACK -y --skip-preview
      - pulumi stack rm $PULUMI_FULLSTACK -y
